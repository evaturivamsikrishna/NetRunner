name: ğŸ•¹ NetRunner Website Monitor & Dashboard (Netlify)

on:
  schedule:
    - cron: "0 */3 * * *"     # every 3 hours
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    name: ğŸ§© Full Monitor + Dashboard Build
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ§° Ensure Directories Exist
        run: |
          mkdir -p data/reports
          mkdir -p data/dashboard/generated
          mkdir -p logs

      - name: ğŸŒ Run NetRunner Scanner
        run: |
          echo "ğŸš€ Running NetRunner..."
          python -m src.main --max-procs=4 || true

      - name: ğŸ“Š Build Dashboard Metrics
        run: |
          echo "ğŸ“ˆ Building metrics..."
          python -m src.analytics.metrics_builder || true

      - name: ğŸ” Verify Generated Output
        run: |
          echo "=== Generated Dashboard Files ==="
          ls -R data/dashboard/generated || true
          echo "=== Reports ==="
          ls -R data/reports || true

      - name: ğŸ’¾ Commit Updated Reports & Dashboard
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data/reports/*.csv data/dashboard/generated/*.json || true
          git commit -m "ğŸ” Auto-update metrics & dashboard [skip ci]" || echo "No changes."
          git push origin main || echo "No push access."

      - name: ğŸŒ Trigger Netlify Deploy
        if: success() && env.NETRUNNER_NETLIFY_HOOK != ''
        env:
          NETRUNNER_NETLIFY_HOOK: ${{ secrets.NETRUNNER_NETLIFY_HOOK }}
        run: |
          echo "ğŸ” Triggering Netlify deployment..."
          curl -X POST -d '{}' ${{ env.NETRUNNER_NETLIFY_HOOK }} \
            && echo "âœ… Netlify triggered." \
            || echo "âš ï¸ Netlify hook failed."